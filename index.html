<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Lokatsiya Tracker</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* === Styling (sizniki) === */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:sans-serif;height:100vh;overflow:hidden}
.container{display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;text-align:center;padding:20px;color:white}
.card{background:rgba(255,255,255,0.15);padding:30px;border-radius:20px;backdrop-filter:blur(10px);box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:350px;width:100%;border:1px solid rgba(255,255,255,0.2)}
.loading-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
.success-bg{background:linear-gradient(135deg,#4CAF50 0%,#45a049 100%)}
.error-bg{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%)}
.spinner{width:60px;height:60px;border:4px solid rgba(255,255,255,0.3);border-top:4px solid white;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 25px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.icon{font-size:60px;margin-bottom:20px}
.title{margin:0 0 15px;font-size:24px;font-weight:bold}
.subtitle{margin:0 0 15px;opacity:0.9;font-size:18px}
.description{margin:0;font-size:14px;opacity:0.7;line-height:1.4}
.retry-btn{background:rgba(255,255,255,0.2);color:white;border:2px solid rgba(255,255,255,0.5);padding:15px 30px;border-radius:25px;cursor:pointer;font-size:16px;font-weight:bold;transition:all .3s ease;width:100%;margin-top:15px}
.retry-btn:hover{background:rgba(255,255,255,0.3)}
</style>
</head>
<body>
<div id="app" class="container loading-bg">
    <div class="card">
        <div class="spinner"></div>
        <h2 class="title">üìç Lokatsiya aniqlanmoqda...</h2>
        <p class="subtitle">üü¢ Botni ishga tushirish</p>
        <p class="description">Lokatsiya ruxsatini tasdiqlang va<br>GPS signalini kutib turing</p>
    </div>
</div>

<script>
let tg;
try {
    tg = window.Telegram.WebApp;
    tg.ready();
} catch (e) {
    console.error('Telegram WebApp yo‚Äòq:', e);
}

// Token yaratish
function getOrCreateToken() {
    try {
        let token = localStorage.getItem('employee_token');
        if (!token) {
            const userId = tg?.initDataUnsafe?.user?.id || Math.random().toString(36).substr(2, 9);
            const timestamp = Date.now();
            const randomPart = Math.random().toString(36).substr(2, 8);
            token = `token_${userId}_${timestamp}_${randomPart}`;
            localStorage.setItem('employee_token', token);
        }
        return token;
    } catch {
        const userId = tg?.initDataUnsafe?.user?.id || Math.random().toString(36).substr(2, 9);
        return `temp_${userId}_${Date.now()}`;
    }
}

// Lokatsiyani olish
function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Brauzer lokatsiyani qo‚Äòllamaydi'));
            return;
        }
        navigator.geolocation.getCurrentPosition(
            (pos) => resolve({
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
                accuracy: pos.coords.accuracy
            }),
            (err) => {
                let msg = 'Xatolik';
                if (err.code === 1) msg = "Ruxsat berilmadi";
                else if (err.code === 2) msg = "GPS mavjud emas";
                else if (err.code === 3) msg = "Vaqt tugadi";
                reject(new Error(msg));
            },
            {enableHighAccuracy:true,timeout:15000,maximumAge:30000}
        );
    });
}

// Botga yuborish
function sendLocationToBot(location) {
    try {
        const token = getOrCreateToken();
        const data = {
            action: "location",
            latitude: location.latitude,
            longitude: location.longitude,
            accuracy: location.accuracy,
            timestamp: new Date().toISOString(),
            token: token,
            user_id: tg?.initDataUnsafe?.user?.id || null
        };
        tg?.sendData(JSON.stringify(data));
        showSuccess(location);
    } catch (e) {
        showError("Ma'lumot yuborishda xato: " + e.message);
    }
}

// Xatolik ko‚Äòrsatish
function showError(message) {
    document.getElementById('app').className = 'container error-bg';
    document.getElementById('app').innerHTML = `
        <div class="card">
            <div class="icon">‚ùå</div>
            <h2 class="title">Xatolik!</h2>
            <p class="description">${message}</p>
            <button class="retry-btn" onclick="initApp()">üîÅ Qayta urinib ko‚Äòrish</button>
        </div>
    `;
}

// Muvaffaqiyatli holat
function showSuccess(loc) {
    document.getElementById('app').className = 'container success-bg';
    document.getElementById('app').innerHTML = `
        <div class="card">
            <div class="icon">‚úÖ</div>
            <h2 class="title">Lokatsiya yuborildi</h2>
            <p class="subtitle">üìç ${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)}</p>
            <p class="description">Aniqlik: ${Math.round(loc.accuracy)} m</p>
        </div>
    `;
}

// Boshlash
async function initApp() {
    document.getElementById('app').className = 'container loading-bg';
    document.getElementById('app').innerHTML = `
        <div class="card">
            <div class="spinner"></div>
            <h2 class="title">üìç Lokatsiya aniqlanmoqda...</h2>
            <p class="subtitle">GPS signalini kuting</p>
        </div>
    `;
    try {
        const location = await getCurrentLocation();
        sendLocationToBot(location);
    } catch (e) {
        showError(e.message);
    }
}

window.onload = initApp;
</script>
</body>
</html>
