// Telegram WebApp obyekti
const tg = window.Telegram?.WebApp;

// WebApp mavjudligini tekshirish
if (!tg) {
    console.error('Telegram WebApp not found');
    document.body.innerHTML = `
        <div style="padding: 20px; text-align: center; color: red;">
            <h3>‚ùå Telegram WebApp topilmadi!</h3>
            <p>Bu sahifa faqat Telegram bot ichida ishlaydi.</p>
        </div>
    `;
}

// Token localStorage dan olish yoki yaratish
function getOrCreateToken() {
    let token = localStorage.getItem('employee_token');
    if (!token) {
        // User ID bilan birlashtirilib unique token yaratish
        const userId = tg?.initDataUnsafe?.user?.id || Math.random().toString(36).substr(2, 9);
        token = `token_${userId}_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        localStorage.setItem('employee_token', token);
    }
    return token;
}

// Lokatsiyani olish funksiyasi
function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Bu brauzer lokatsiya xizmatini qo\'llab-quvvatlamaydi'));
            return;
        }

        const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 30000
        };

        navigator.geolocation.getCurrentPosition(
            (position) => {
                resolve({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                });
            },
            (error) => {
                let errorMessage;
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "Lokatsiya ruxsati berilmadi. Sozlamalardan ruxsat bering.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "Lokatsiya xizmati mavjud emas. GPS yoqilganini tekshiring.";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "Lokatsiya olish vaqti tugadi. Qaytadan urinib ko'ring.";
                        break;
                    default:
                        errorMessage = `Lokatsiya xatoligi: ${error.message}`;
                        break;
                }
                reject(new Error(errorMessage));
            },
            options
        );
    });
}

// Ma'lumotlarni botga yuborish
function sendLocationToBot(action, location) {
    try {
        const token = getOrCreateToken();
        
        const data = {
            action: action, // 'arrival' yoki 'departure'  
            latitude: location.latitude,
            longitude: location.longitude,
            accuracy: location.accuracy,
            timestamp: new Date().toISOString(),
            token: token,
            user_id: tg?.initDataUnsafe?.user?.id || null
        };

        console.log('Sending data to bot:', data);

        // Telegram WebApp orqali ma'lumot yuborish
        if (tg && typeof tg.sendData === 'function') {
            tg.sendData(JSON.stringify(data));
        } else {
            throw new Error('Telegram WebApp sendData funksiyasi mavjud emas');
        }
    } catch (error) {
        console.error('Error sending data to bot:', error);
        showError(`Ma'lumot yuborishda xatolik: ${error.message}`);
    }
}

// Xatolik ko'rsatish funksiyasi
function showError(message) {
    document.body.innerHTML = `
        <div style="
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            text-align: center;
            padding: 20px;
            margin: 0;
        ">
            <div style="
                background: rgba(255,255,255,0.15);
                padding: 30px;
                border-radius: 20px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                max-width: 350px;
                width: 100%;
                border: 1px solid rgba(255,255,255,0.2);
            ">
                <div style="font-size: 60px; margin-bottom: 20px;">‚ùå</div>
                <h2 style="margin: 0 0 15px 0; font-size: 24px;">Xatolik!</h2>
                <p style="margin: 0 0 25px 0; opacity: 0.9; line-height: 1.5; font-size: 16px;">
                    ${message}
                </p>
                <button onclick="location.reload()" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    border: 2px solid rgba(255,255,255,0.5);
                    padding: 15px 30px;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    width: 100%;
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    üîÑ Qaytadan urinish
                </button>
            </div>
        </div>
    `;
}

// Muvaffaqiyat sahifasini ko'rsatish
function showSuccess(location, action) {
    const actionText = action === 'arrival' ? 'Keldim' : 'Ketdim';
    const actionIcon = action === 'arrival' ? 'üü¢' : 'üî¥';
    
    document.body.innerHTML = `
        <div style="
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            text-align: center;
            padding: 20px;
            margin: 0;
        ">
            <div style="
                background: rgba(255,255,255,0.15);
                padding: 30px;
                border-radius: 20px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                max-width: 350px;
                width: 100%;
                border: 1px solid rgba(255,255,255,0.2);
            ">
                <div style="font-size: 60px; margin-bottom: 20px;">‚úÖ</div>
                <h2 style="margin: 0 0 15px 0; font-size: 24px;">
                    ${actionIcon} ${actionText} belgilandi!
                </h2>
                <p style="margin: 0 0 10px 0; opacity: 0.9; font-size: 14px;">
                    üìç Lat: ${location.latitude.toFixed(6)}
                </p>
                <p style="margin: 0 0 15px 0; opacity: 0.9; font-size: 14px;">
                    üìç Lon: ${location.longitude.toFixed(6)}
                </p>
                <p style="margin: 0 0 10px 0; opacity: 0.8; font-size: 14px;">
                    üìä Aniqlik: ${Math.round(location.accuracy)} metr
                </p>
                <div style="
                    margin: 20px 0;
                    padding: 10px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 10px;
                    font-size: 14px;
                    opacity: 0.8;
                ">
                    Ma'lumot botga yuborildi ‚úàÔ∏è
                </div>
            </div>
        </div>
    `;
}

// Loading sahifasini ko'rsatish
function showLoading(action) {
    const actionText = action === 'arrival' ? 'Keldim' : 'Ketdim';
    const actionIcon = action === 'arrival' ? 'üü¢' : 'üî¥';
    
    document.body.innerHTML = `
        <div style="
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 20px;
            margin: 0;
        ">
            <div style="
                background: rgba(255,255,255,0.15);
                padding: 30px;
                border-radius: 20px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                max-width: 350px;
                width: 100%;
                border: 1px solid rgba(255,255,255,0.2);
            ">
                <div style="
                    width: 60px;
                    height: 60px;
                    border: 4px solid rgba(255,255,255,0.3);
                    border-top: 4px solid white;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 25px;
                "></div>
                <h2 style="margin: 0 0 15px 0; font-size: 24px;">
                    üìç Lokatsiya aniqlanmoqda...
                </h2>
                <p style="margin: 0 0 15px 0; opacity: 0.9; font-size: 18px;">
                    ${actionIcon} ${actionText} tugmasi bosildi
                </p>
                <p style="margin: 0; font-size: 14px; opacity: 0.7; line-height: 1.4;">
                    Lokatsiya ruxsatini tasdiqlang va<br>
                    GPS signalini kutib turing
                </p>
            </div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { margin: 0 !important; }
        </style>
    `;
}

// Asosiy funksiya
function initWebApp() {
    if (!tg) {
        showError('Bu sahifa faqat Telegram bot ichida ishlaydi');
        return;
    }

    // Telegram WebApp ni kengaytirish
    tg.expand();
    
    // URL parametrlaridan action ni aniqlash
    const urlParams = new URLSearchParams(window.location.search);
    const buttonText = tg?.initDataUnsafe?.button_text || '';
    
    let action = 'arrival'; // default
    
    // Tugma textiga qarab action ni aniqlash
    if (buttonText.includes('Ketdim') || buttonText.includes('‚ùå')) {
        action = 'departure';
    } else if (buttonText.includes('Keldim') || buttonText.includes('‚úÖ')) {
        action = 'arrival';
    }
    
    // URL parametridan ham tekshirish
    if (urlParams.get('action')) {
        action = urlParams.get('action');
    }

    console.log('WebApp initialized with action:', action);
    
    // Loading sahifasini ko'rsatish
    showLoading(action);

    // Lokatsiyani olish
    setTimeout(() => {
        getCurrentLocation()
            .then(location => {
                console.log('Location obtained:', location);
                showSuccess(location, action);
                sendLocationToBot(action, location);
                
                // 3 soniya kutib WebApp ni yopish
                setTimeout(() => {
                    if (tg && typeof tg.close === 'function') {
                        tg.close();
                    }
                }, 3000);
            })
            .catch(error => {
                console.error('Location error:', error);
                showError(error.message);
            });
    }, 1000);
}

// Sahifa yuklanganda ishga tushirish
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWebApp);
} else {
    initWebApp();
}

// Telegram WebApp tayyor bo'lganini bildirish
if (tg && typeof tg.ready === 'function') {
    tg.ready();
}
