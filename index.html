// Telegram WebApp obyekti
const tg = window.Telegram.WebApp;

// Token localStorage dan olish yoki yaratish
function getOrCreateToken() {
    let token = localStorage.getItem('employee_token');
    if (!token) {
        token = 'token_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        localStorage.setItem('employee_token', token);
    }
    return token;
}

// Lokatsiyani olish funksiyasi
function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Geolocation is not supported'));
            return;
        }

        const options = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        };

        navigator.geolocation.getCurrentPosition(
            (position) => {
                resolve({
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                });
            },
            (error) => {
                let errorMessage;
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "Lokatsiya ruxsati berilmadi";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "Lokatsiya ma'lumoti mavjud emas";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "Lokatsiya so'rovi vaqti tugadi";
                        break;
                    default:
                        errorMessage = "Noma'lum xatolik";
                        break;
                }
                reject(new Error(errorMessage));
            },
            options
        );
    });
}

// Ma'lumotlarni botga yuborish
function sendLocationToBot(action, location) {
    const token = getOrCreateToken();
    
    const data = {
        action: action, // 'arrival' yoki 'departure'
        latitude: location.latitude,
        longitude: location.longitude,
        accuracy: location.accuracy,
        timestamp: new Date().toISOString(),
        token: token
    };

    // Telegram WebApp orqali ma'lumot yuborish
    tg.sendData(JSON.stringify(data));
}

// Sahifa yuklanganda
document.addEventListener('DOMContentLoaded', function() {
    // Telegram WebApp ni kengaytirish
    tg.expand();
    
    // URL parametrlarini tekshirish
    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action') || 'arrival';
    
    // Loading ko'rsatish
    document.body.innerHTML = `
        <div style="
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 20px;
        ">
            <div style="
                background: rgba(255,255,255,0.1);
                padding: 30px;
                border-radius: 20px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                max-width: 300px;
                width: 100%;
            ">
                <div style="
                    width: 50px;
                    height: 50px;
                    border: 3px solid rgba(255,255,255,0.3);
                    border-top: 3px solid white;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                "></div>
                <h2 style="margin: 0 0 15px 0;">üìç Lokatsiya olinmoqda...</h2>
                <p style="margin: 0; opacity: 0.8;">
                    ${action === 'arrival' ? 'üü¢ Keldim' : 'üî¥ Ketdim'} tugmasi bosildi
                </p>
                <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.7;">
                    Lokatsiya ruxsatini bering
                </p>
            </div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            body { margin: 0; }
        </style>
    `;

    // Lokatsiyani olish va yuborish
    setTimeout(() => {
        getCurrentLocation()
            .then(location => {
                // Muvaffaqiyat sahifasi
                document.body.innerHTML = `
                    <div style="
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        height: 100vh;
                        font-family: Arial, sans-serif;
                        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                        color: white;
                        text-align: center;
                        padding: 20px;
                    ">
                        <div style="
                            background: rgba(255,255,255,0.1);
                            padding: 30px;
                            border-radius: 20px;
                            backdrop-filter: blur(10px);
                            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                            max-width: 300px;
                            width: 100%;
                        ">
                            <div style="
                                font-size: 60px;
                                margin-bottom: 20px;
                            ">‚úÖ</div>
                            <h2 style="margin: 0 0 15px 0;">Lokatsiya topildi!</h2>
                            <p style="margin: 0 0 10px 0; opacity: 0.9;">
                                üìç Lat: ${location.latitude.toFixed(6)}
                            </p>
                            <p style="margin: 0 0 20px 0; opacity: 0.9;">
                                üìç Lon: ${location.longitude.toFixed(6)}
                            </p>
                            <p style="margin: 0; font-size: 14px; opacity: 0.8;">
                                Ma'lumot botga yuborilmoqda...
                            </p>
                        </div>
                    </div>
                `;

                // Ma'lumotni botga yuborish
                sendLocationToBot(action, location);
                
                // Biroz kutib, sahifani yopish
                setTimeout(() => {
                    tg.close();
                }, 2000);
            })
            .catch(error => {
                // Xatolik sahifasi
                document.body.innerHTML = `
                    <div style="
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        height: 100vh;
                        font-family: Arial, sans-serif;
                        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
                        color: white;
                        text-align: center;
                        padding: 20px;
                    ">
                        <div style="
                            background: rgba(255,255,255,0.1);
                            padding: 30px;
                            border-radius: 20px;
                            backdrop-filter: blur(10px);
                            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                            max-width: 300px;
                            width: 100%;
                        ">
                            <div style="
                                font-size: 60px;
                                margin-bottom: 20px;
                            ">‚ùå</div>
                            <h2 style="margin: 0 0 15px 0;">Xatolik!</h2>
                            <p style="margin: 0 0 20px 0; opacity: 0.9;">
                                ${error.message}
                            </p>
                            <button onclick="location.reload()" style="
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: 2px solid rgba(255,255,255,0.5);
                                padding: 12px 24px;
                                border-radius: 25px;
                                cursor: pointer;
                                font-size: 16px;
                                transition: all 0.3s ease;
                            ">
                                üîÑ Qaytadan urinish
                            </button>
                        </div>
                    </div>
                `;
            });
    }, 1000);
});

// Telegram WebApp tayyor bo'lganini bildirish
tg.ready();
