<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>Lokatsiya yuborish</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .container {
      text-align: center;
      padding: 2rem;
      border-radius: 20px;
      max-width: 350px;
      width: 90%;
      color: #333;
    }
    .loading-bg { background: #fff3cd; }
    .success-bg { background: #d4edda; }
    .error-bg { background: #f8d7da; }

    .card { display: flex; flex-direction: column; gap: 1rem; }

    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid #333;
      border-radius: 50%;
      margin: 0 auto;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .icon {
      font-size: 3rem;
    }

    .title { font-size: 1.3rem; font-weight: bold; }
    .subtitle { font-size: 1rem; }
    .description { font-size: 0.9rem; color: #555; }

    .retry-btn {
      padding: 0.7rem 1rem;
      border: none;
      border-radius: 10px;
      background: #333;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="card">
      <div class="spinner"></div>
      <h2 class="title">Yuklanmoqda...</h2>
      <p class="description">Iltimos kuting</p>
    </div>
  </div>

  <!-- Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    async function initWebApp() {
      const tg = window.Telegram.WebApp;
      tg.ready();

      function determineAction() {
        const hour = new Date().getHours();
        return hour < 12 ? 'arrival' : 'departure';
      }

      const action = determineAction();
      const actionText = action === 'arrival' ? 'Keldim' : 'Ketdim';
      const actionIcon = action === 'arrival' ? 'üü¢' : 'üî¥';

      const app = document.getElementById('app');
      app.className = 'container loading-bg';
      app.innerHTML = `
          <div class="card">
              <div class="spinner"></div>
              <h2 class="title">üìç Lokatsiya aniqlanmoqda...</h2>
              <p class="subtitle">${actionIcon} ${actionText} jarayoni</p>
              <p class="description">GPS signalini kuting</p>
          </div>
      `;

      function getCurrentLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('Brauzer lokatsiyani qo‚Äòllamaydi'));
            return;
          }
          navigator.geolocation.getCurrentPosition(
            (pos) => resolve({
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude,
              accuracy: pos.coords.accuracy
            }),
            (err) => {
              let msg = 'Xatolik';
              if (err.code === 1) msg = "Ruxsat berilmadi";
              else if (err.code === 2) msg = "GPS mavjud emas";
              else if (err.code === 3) msg = "Vaqt tugadi";
              reject(new Error(msg));
            },
            { enableHighAccuracy:true, timeout:15000, maximumAge:30000 }
          );
        });
      }

      try {
        const loc = await getCurrentLocation();

        tg.sendData(JSON.stringify({
          action: action,
          latitude: loc.latitude,
          longitude: loc.longitude,
          accuracy: loc.accuracy,
          timestamp: new Date().toISOString()
        }));

        app.className = 'container success-bg';
        app.innerHTML = `
            <div class="card">
                <div class="icon">‚úÖ</div>
                <h2 class="title">${actionText} ma'lumoti yuborildi</h2>
                <p class="subtitle">üìç ${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)}</p>
                <p class="description">Aniqlik: ${Math.round(loc.accuracy)} m</p>
            </div>
        `;
      } catch (e) {
        app.className = 'container error-bg';
        app.innerHTML = `
            <div class="card">
                <div class="icon">‚ùå</div>
                <h2 class="title">Xatolik</h2>
                <p class="description">${e.message}</p>
                <button class="retry-btn" onclick="initWebApp()">üîÅ Qayta urinib ko‚Äòrish</button>
            </div>
        `;
      }
    }

    initWebApp();
  </script>
</body>
</html>
