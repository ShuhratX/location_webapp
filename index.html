<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Lokatsiya Tracker</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 40px;
      text-align: center;
    }
    h1 {
      margin-bottom: 30px;
      color: #333;
    }
    button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 15px auto;
      padding: 15px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
    }
    #keldim { background: #4CAF50; }
    #ketdim { background: #F44336; }
  </style>
</head>
<body>
  <h1>Lokatsiya Tracker</h1>
  <button id="keldim">üìç Keldim</button>
  <button id="ketdim">üö∂‚Äç‚ôÇÔ∏è Ketdim</button>

  <script>
    const tg = window.Telegram.WebApp;

    // localStorage dan token olish yoki yaratish
    function getOrCreateToken() {
      let token = localStorage.getItem('employee_token');
      if (!token) {
        const userId = tg?.initDataUnsafe?.user?.id || Math.random().toString(36).slice(2);
        const rand = Math.random().toString(36).slice(2, 8);
        token = `token_${userId}_${Date.now()}_${rand}`;
        localStorage.setItem('employee_token', token);
      }
      return token;
    }

    function sendLocation(action) {
      if (!navigator.geolocation) {
        tg.showAlert("üìç Lokatsiya xizmati mavjud emas!");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const data = {
            action: action,
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            token: getOrCreateToken()
          };
          tg.sendData(JSON.stringify(data));
          tg.close();
        },
        (err) => {
          tg.showAlert("‚ùå Lokatsiya olinmadi: " + err.message);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    document.getElementById("keldim").addEventListener("click", () => sendLocation("Keldim"));
    document.getElementById("ketdim").addEventListener("click", () => sendLocation("Ketdim"));
  </script>
</body>
</html>
